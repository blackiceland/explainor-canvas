# Система размещения кода в сценах

## Контракты (гарантии системы)

### 1. placeCode(code, position, fontSize)
- Возвращает `{ x, y, width, fontSize }`
- **width** вычисляется автоматически по длине кода + padding
- **position** = anchor (TL = верхний левый угол блока у верхнего левого угла safe zone)
- **fontSize** — что передал, то и получил (система НЕ меняет)

### 2. placeCodeStack(codes[], align, fontSize)
- Возвращает массив `{ x, y, width, height, fontSize }[]`
- **Все карточки одинакового размера** (по самой большой)
- **Зазор между карточками**: 60px (STACK_GAP)
- **Вертикальная композиция**: стек центрируется по SafeZone (чтобы верх/низ выглядели сбалансировано)
- **fontSize** — что передал, то и получил (система НЕ меняет)
- Если не помещается — твоя ответственность (уменьши fontSize или код)

### 3. Padding (отступ от кода до края карточки)
- Горизонталь (X): `fontSize * 2 + 8`, ограничено 24–56px
  - При fontSize 16 → 40px (совпадает с таблицей: 24 + 16)
- Вертикаль (Y): `fontSize * 1.5 + 8`, ограничено 24–48px
  - При fontSize 16 → 32px

### 4. Safe Zone
- Вертикаль: от -480 до +480 (960px)
- Горизонталь: от -840 до +840 (1680px)

---

## API

### placeCode — одиночный блок
```typescript
const layout = placeCode(CODE, 'TL', 16);
// → { x, y, width, fontSize }
```

### placeCodeStack — группа блоков (вертикальный стек)
```typescript
const layouts = placeCodeStack([CODE1, CODE2], 'L', 16);
// → [{ x, y, width, height, fontSize }, ...]
```

**align**: `'L'` (слева), `'C'` (центр), `'R'` (справа)

---

## Позиции (position)

```
    TL   TC   TR
    ML   C    MR
    BL   BC   BR
```

- TL = top-left (верхний левый угол блока у safe zone)
- C = center (центр блока в центре экрана)
- и т.д.

Алиасы: `L` = ML, `R` = MR, `T` = TC, `B` = BC

---

## Пример сцены (референс)

```typescript
import {makeScene2D} from '@motion-canvas/2d';
import {waitFor} from '@motion-canvas/core';
import {CodeBlock} from '../core/code/components/CodeBlock';
import {ExplainorCodeTheme} from '../core/code/model/SyntaxTheme';
import {placeCodeStack, SafeZone} from '../core/ScreenGrid';
import {Fonts, Timing} from '../core/theme';
import {applyBackground} from '../core/utils';

const CODE_1 = `...`;
const CODE_2 = `...`;

export default makeScene2D(function* (view) {
  applyBackground(view);

  // Иммутабельный подход — НЕ мутируем результат placeCodeStack
  const baseLayouts = placeCodeStack([CODE_1, CODE_2], 'L', 16);
  const layout1 = {...baseLayouts[0]};
  const layout2 = {...baseLayouts[1]};
  
  const block1 = CodeBlock.fromCode(CODE_1, {
    x: layout1.x,
    y: layout1.y,
    width: layout1.width,
    height: layout1.height,
    fontSize: layout1.fontSize,
    fontFamily: Fonts.code,
    theme: ExplainorCodeTheme,
    contentOffsetX: 20,  // Сдвиг кода внутри карточки вправо
    customTypes: ['MyClass', 'OtherClass'],
  });

  const block2 = CodeBlock.fromCode(CODE_2, {
    x: layout2.x,
    y: layout2.y,
    width: layout2.width,
    height: layout2.height,
    fontSize: layout2.fontSize,
    fontFamily: Fonts.code,
    theme: ExplainorCodeTheme,
    contentOffsetX: 20,
    customTypes: ['MyClass', 'OtherClass'],
  });

  block1.mount(view);
  yield* block1.appear(Timing.slow);
  
  yield* waitFor(2);
  
  block2.mount(view);
  yield* block2.appear(Timing.slow);
  
  yield* waitFor(3);
});
```

---

## customTypes (ВАЖНО)

AI должен САМ анализировать код и определять customTypes:
1. Найти все слова с заглавной буквы, которые выглядят как классы/типы
2. Исключить стандартные (List, Map, String, Optional и т.д.)
3. Добавить остальные в customTypes

Без этого кастомные классы будут белыми вместо бежевых.

---

## Подсветка condition (как в dryKnowledgeScene)

Паттерн: приглушаем всё кроме нужных строк и красим их в `Colors.accent` (розовый `#FF8CA3`).

```typescript
const conditionLineIndex = 9;
const whereLineIndex = 12;

yield* all(
  repo.highlightLines([[conditionLineIndex, conditionLineIndex], [whereLineIndex, whereLineIndex]], Timing.slow),
  repo.recolorLine(conditionLineIndex, Colors.accent, Timing.slow),
  repo.recolorLine(whereLineIndex, Colors.accent, Timing.slow),
);
```

---

## Константы

| Константа | Значение | Описание |
|-----------|----------|----------|
| STACK_GAP | 60px | Зазор между карточками в стеке |
| MIN_CARD_WIDTH | 300px | Минимальная ширина карточки |
| MAX_CARD_WIDTH | 1600px | Максимальная ширина карточки |
| SafeZone.top | -480 | Верхняя граница рабочей области |
| SafeZone.bottom | 480 | Нижняя граница рабочей области |
| SafeZone.left | -840 | Левая граница рабочей области |
| SafeZone.right | 840 | Правая граница рабочей области |

---

## Форматирование кода (внутри строк)

### Отступы
- **2 пробела** (не табы)
- Внутри `{ }` — всегда отступ

### Пустые строки
- После `{` класса
- Между полями и конструктором
- Между конструктором и методами
- Перед `return` (если есть подготовка)

### Переносы
- Fluent-цепочки — "лесенкой":
  ```java
  dsl.selectFrom(PAYMENTS)
    .where(condition)
    .fetch();
  ```

---

## Цветовая тема (ExplainorCodeTheme)

| Токен | Цвет | Примеры |
|-------|------|---------|
| keyword | #E6B47C (оранжевый) | `final`, `class`, `return`, `this` |
| type | #D5CCBF (бежевый) | `List`, `String`, + customTypes |
| constant | #C8B8D8 (лавандовый) | `PAYMENTS`, `ORDERS` |
| method | #B8D4E8 (голубой) | `.selectFrom()`, `.fetch()` |
| string | #B2C7C9 (голубой) | `"text"` |
| number | #A5C9CA (голубой) | `123`, `0.5` |
| plain | #FCFBF8 (белый) | переменные, параметры |
| punctuation | #EBE8E2 (бежево-белый) | `{}`, `()`, `;` |
| comment | #4A505E (тёмный) | `// comment` |

---

## Карточка (card vs nocard)

- **card** (по умолчанию) — фон + тень
- **nocard** — прозрачный фон, только код:
  ```typescript
  import {NoCardStyle} from '../core/ScreenGrid';
  
  CodeBlock.fromCode(CODE, {
    ...layout,
    cardStyle: NoCardStyle,
  });
  ```

---

## contentOffsetX (сдвиг кода внутри карточки)

Когда карточка шире кода, можно сдвинуть код вправо для визуального баланса:

```typescript
CodeBlock.fromCode(CODE, {
  ...layout,
  contentOffsetX: 20,  // px вправо от центра
});
```

Важно: левый отступ текста от края карточки считается как `getCodePadding(fontSize) + contentOffsetX`.
Чтобы совпасть с таблицей (24 + 16 = 40px при FONT_SIZE 16), держим `contentOffsetX: 0`.

---

## Равные размеры карточек (код + таблица)

Когда нужны карточки одинаковой ширины слева и справа:

```typescript
const gap = 120;
const totalWidth = SafeZone.right - SafeZone.left;  // 1680px
const cardWidth = (totalWidth - gap) / 2;           // 780px каждая
const codeX = SafeZone.left + cardWidth / 2;
const tableX = SafeZone.right - cardWidth / 2;

// Иммутабельно переопределяем layouts
const baseLayouts = placeCodeStack([CODE_1, CODE_2], 'L', 16);
const layout1 = {...baseLayouts[0], x: codeX, width: cardWidth};
const layout2 = {...baseLayouts[1], x: codeX, width: cardWidth};
```

---

## Таблицы (layout + measureText)

### Ключевая идея

Таблицу **нельзя** собирать через ручные `x/y` для каждой ячейки. Нужны две опоры:
1) **Layout Motion Canvas** (`layout`, `direction`, `padding`, `alignItems`) — отвечает за геометрию
2) **Реальное измерение текста** (`CanvasRenderingContext2D.measureText()`) — отвечает за ellipsis

### Гарантии

- Текст не вылезает за границы: сначала `fitText(...)` (ellipsis по реальному `measureText`), затем `clip` как страховка.
- Колонки равномерные: `grow={1} shrink={1} basis={0} minWidth={0}` на каждой ячейке.
- Выравнивание текста: через `textAlign` на `Txt` с `width={'100%'}`.

### Геометрия карточек (код + таблица рядом)

**Правило равных отступов:**
- `edgeMargin = 120px` — отступ от края кадра до карточки кода
- `edgeMargin = 120px` — отступ между карточкой кода и таблицей
- Таблица растягивается до `SafeZone.right` (автоматически 120px от края кадра)

```typescript
const codeRight = codeLayout.x + codeLayout.width / 2;
const edgeMargin = 120;
const tableLeft = codeRight + edgeMargin;
const tableRight = SafeZone.right;
const tableWidth = tableRight - tableLeft;
const tableX = tableLeft + tableWidth / 2;
const tableY = codeLayout.y;  // Выравнивание по верхней карточке кода
```

### Разделители колонок (бесшовные)

**Не использовать `stroke` на ячейках** — рисует обводку со всех сторон.

Вместо этого — отдельные вертикальные `Rect` между колонками:

```tsx
{columns.map((col, i) => (
  <>
    <Rect layout grow={1} shrink={1} basis={0} minWidth={0} ...>
      <Txt ... />
    </Rect>
    {i < columns.length - 1 && (
      <Rect width={1} height={'100%'} fill={'rgba(255, 255, 255, 0.08)'} shrink={0} />
    )}
  </>
))}
```

### API для ellipsis

Файл: `motion-canvas/src/core/utils/textMeasure.ts`

- `fitText(text, maxPx, mode, fontFamily, fontSize, fontWeight)`
  - mode: `'end'` (обычный ellipsis) или `'middle'` (UUID как в DB-гридах)

### Референс таблицы (полный)

```typescript
import {Rect, Txt, makeScene2D} from '@motion-canvas/2d';
import {createRef, easeInOutCubic} from '@motion-canvas/core';
import {fitText} from '../core/utils/textMeasure';
import {placeCodeStack, SafeZone} from '../core/ScreenGrid';
import {Colors, Fonts, Timing} from '../core/theme';

// Константы
const TABLE_PADDING = 24;
const ROW_H = 48;
const CELL_PX = 16;
const FONT_SIZE = 16;
const FONT_WEIGHT = 400;
const TITLE_H = 24;
const TITLE_FONT_SIZE = 14;

// Колонки (без width — flex поделит равномерно)
const baseColumns = [
  {key: 'id', header: 'id', ellipsis: 'middle', align: 'left'},
  {
    key: 'status',
    header: 'status',
    ellipsis: 'end',
    align: 'left',
    color: (v) => v === 'CAPTURED' ? '#A8D8C0' : v === 'PENDING' ? '#E6B47C' : Colors.text.muted,
  },
  {key: 'amount', header: 'amount', ellipsis: 'end', align: 'left'},
  {key: 'created_at', header: 'created_at', ellipsis: 'end', align: 'left'},
];

// Данные (реалистичные)
const rows = [
  {id: '550e8400-e29b-41d4-a716-446655440000', status: 'CAPTURED', amount: '$99.00', created_at: '2024-12-15 14:32'},
  {id: '6ba7b810-9dad-11d1-80b4-00c04fd430c8', status: 'DECLINED', amount: '$150.00', created_at: '2024-12-14 09:15'},
  // ...
];

// Геометрия
const codeRight = codeLayout.x + codeLayout.width / 2;
const edgeMargin = 120;
const tableLeft = codeRight + edgeMargin;
const tableRight = SafeZone.right;
const tableWidth = tableRight - tableLeft;
const tableX = tableLeft + tableWidth / 2;
const tableY = codeLayout.y;
const contentWidth = tableWidth - TABLE_PADDING * 2;

// Карточка таблицы
<Rect
  ref={tableRef}
  x={tableX}
  y={tableY}
  width={tableWidth}
  height={codeLayout.height}  // Высота = высота карточки кода
  layout
  direction={'column'}
  gap={0}
  padding={TABLE_PADDING}
  radius={28}
  fill={Colors.surface}
  stroke={'rgba(255, 255, 255, 0.03)'}
  lineWidth={2}
  shadowColor={'rgba(0, 0, 0, 0.28)'}
  shadowBlur={74}
  shadowOffset={[0, 22]}
  clip
>
  <Rect layout direction={'row'} height={TITLE_H} width={contentWidth} justifyContent={'start'} alignItems={'center'} clip marginBottom={10}>
    <Txt fontFamily={Fonts.code} fontSize={TITLE_FONT_SIZE} fontWeight={600} fill={'rgba(219, 213, 202, 0.72)'} text={'PAYMENTS'} />
  </Rect>
  {/* Header row */}
  <Rect layout direction={'row'} height={ROW_H} width={contentWidth} justifyContent={'start'} clip>
    {baseColumns.map((col, i) => (
      <>
        <Rect
          layout
          grow={1}
          shrink={1}
          basis={0}
          minWidth={0}
          height={'100%'}
          paddingLeft={CELL_PX}
          paddingRight={CELL_PX}
          alignItems={'center'}
          justifyContent={'start'}
          clip
        >
          <Txt
            width={'100%'}
            minWidth={0}
            textWrap={false}
            textAlign={col.align === 'right' ? 'right' : 'left'}
            fontFamily={Fonts.code}
            fontSize={FONT_SIZE}
            fontWeight={600}
            fill={'rgba(252, 251, 248, 0.5)'}
            text={col.header}
          />
        </Rect>
        {i < baseColumns.length - 1 && (
          <Rect width={1} height={'100%'} fill={'rgba(255, 255, 255, 0.08)'} shrink={0} />
        )}
      </>
    ))}
  </Rect>

  {/* Data rows */}
  {rows.map((row, rowIndex) => (
    <Rect
      layout
      direction={'row'}
      height={ROW_H}
      width={contentWidth}
      justifyContent={'start'}
      clip
      marginTop={rowIndex === 0 ? 8 : 0}
    >
      {baseColumns.map((col, i) => {
        const raw = row[col.key];
        const cellWidth = contentWidth / baseColumns.length;
        const avail = cellWidth - CELL_PX * 2;
        const shown = fitText(raw, avail, col.ellipsis ?? 'end', Fonts.code, FONT_SIZE, FONT_WEIGHT);
        const textColor = col.color ? col.color(raw) : Colors.text.primary;

        return (
          <>
            <Rect
              layout
              grow={1}
              shrink={1}
              basis={0}
              minWidth={0}
              height={'100%'}
              paddingLeft={CELL_PX}
              paddingRight={CELL_PX}
              alignItems={'center'}
              justifyContent={'start'}
              clip
            >
              <Txt
                width={'100%'}
                minWidth={0}
                textWrap={false}
                textAlign={col.align === 'right' ? 'right' : 'left'}
                fontFamily={Fonts.code}
                fontSize={FONT_SIZE}
                fontWeight={FONT_WEIGHT}
                fill={textColor}
                text={shown}
              />
            </Rect>
            {i < baseColumns.length - 1 && (
              <Rect width={1} height={'100%'} fill={'rgba(255, 255, 255, 0.08)'} shrink={0} />
            )}
          </>
        );
      })}
    </Rect>
  ))}
</Rect>

// Анимация появления (вместе с кодом) — только opacity, без scale
yield* all(
  codeBlock.appear(Timing.slow),
  tableRef().opacity(1, Timing.slow, easeInOutCubic),
);
```

### Цвета статусов

- success (CAPTURED): `#A8D8C0`
- warning (PENDING): `#E6B47C`
- muted (DECLINED, etc.): `Colors.text.muted`

---

## Ключевые файлы

| Файл | Назначение |
|------|------------|
| `motion-canvas/src/scenes/*.tsx` | Сцены видео |
| `motion-canvas/src/core/ScreenGrid.ts` | placeCode, placeCodeStack, SafeZone |
| `motion-canvas/src/core/code/model/SyntaxTheme.ts` | Цветовая тема |
| `motion-canvas/src/core/code/model/Tokenizer.ts` | Токенизатор (customTypes) |
| `motion-canvas/src/core/code/components/CodeBlock.ts` | Компонент кода |
| `motion-canvas/src/core/code/shared/TextMeasure.ts` | Расчёт размеров |
| `motion-canvas/src/core/utils/textMeasure.ts` | Реальное измерение текста + ellipsis |

---

## ВАЖНО: core не трогать!

Файлы в `motion-canvas/src/core/` менять только по явной просьбе.
