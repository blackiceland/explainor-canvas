# Система размещения кода в сценах

## Контракты (гарантии системы)

### 1. placeCode(code, position, fontSize)
- Возвращает `{ x, y, width, fontSize }`
- **width** вычисляется автоматически по длине кода + padding
- **position** = anchor (TL = верхний левый угол блока у верхнего левого угла safe zone)
- **fontSize** — что передал, то и получил (система НЕ меняет)

### 2. placeCodeStack(codes[], align, fontSize)
- Возвращает массив `{ x, y, width, height, fontSize }[]`
- **Все карточки одинакового размера** (по самой большой)
- **Зазор между карточками**: 60px (STACK_GAP)
- **fontSize** — что передал, то и получил (система НЕ меняет)
- Если не помещается — твоя ответственность (уменьши fontSize или код)

### 3. Padding (отступ от кода до края карточки)
- Формула: `fontSize * 1.5 + 8`, ограничено 24–48px
- При fontSize 16 → ~32px

### 4. Safe Zone
- Вертикаль: от -480 до +480 (960px)
- Горизонталь: от -840 до +840 (1680px)

---

## API

### placeCode — одиночный блок
```typescript
const layout = placeCode(CODE, 'TL', 16);
// → { x, y, width, fontSize }
```

### placeCodeStack — группа блоков (вертикальный стек)
```typescript
const layouts = placeCodeStack([CODE1, CODE2], 'L', 16);
// → [{ x, y, width, height, fontSize }, ...]
```

**align**: `'L'` (слева), `'C'` (центр), `'R'` (справа)

---

## Позиции (position)

```
    TL   TC   TR
    ML   C    MR
    BL   BC   BR
```

- TL = top-left (верхний левый угол блока у safe zone)
- C = center (центр блока в центре экрана)
- и т.д.

Алиасы: `L` = ML, `R` = MR, `T` = TC, `B` = BC

---

## Пример сцены (референс)

```typescript
import {makeScene2D} from '@motion-canvas/2d';
import {waitFor} from '@motion-canvas/core';
import {CodeBlock} from '../core/code/components/CodeBlock';
import {ExplainorCodeTheme} from '../core/code/model/SyntaxTheme';
import {placeCodeStack} from '../core/ScreenGrid';
import {Fonts, Timing} from '../core/theme';
import {applyBackground} from '../core/utils';

const CODE_1 = `...`;
const CODE_2 = `...`;

export default makeScene2D(function* (view) {
  applyBackground(view);

  const layouts = placeCodeStack([CODE_1, CODE_2], 'L', 16);
  const [layout1, layout2] = layouts;
  
  const block1 = CodeBlock.fromCode(CODE_1, {
    x: layout1.x,
    y: layout1.y,
    width: layout1.width,
    height: layout1.height,
    fontSize: layout1.fontSize,
    fontFamily: Fonts.code,
    theme: ExplainorCodeTheme,
    customTypes: ['MyClass', 'OtherClass'],
  });

  const block2 = CodeBlock.fromCode(CODE_2, {
    x: layout2.x,
    y: layout2.y,
    width: layout2.width,
    height: layout2.height,
    fontSize: layout2.fontSize,
    fontFamily: Fonts.code,
    theme: ExplainorCodeTheme,
    customTypes: ['MyClass', 'OtherClass'],
  });

  block1.mount(view);
  yield* block1.appear(Timing.slow);
  
  yield* waitFor(2);
  
  block2.mount(view);
  yield* block2.appear(Timing.slow);
  
  yield* waitFor(3);
});
```

---

## customTypes (ВАЖНО)

AI должен САМ анализировать код и определять customTypes:
1. Найти все слова с заглавной буквы, которые выглядят как классы/типы
2. Исключить стандартные (List, Map, String, Optional и т.д.)
3. Добавить остальные в customTypes

Без этого кастомные классы будут белыми вместо бежевых.

---

## Константы

| Константа | Значение | Описание |
|-----------|----------|----------|
| STACK_GAP | 60px | Зазор между карточками в стеке |
| MIN_CARD_WIDTH | 300px | Минимальная ширина карточки |
| MAX_CARD_WIDTH | 1600px | Максимальная ширина карточки |
| SafeZone.top | -480 | Верхняя граница рабочей области |
| SafeZone.bottom | 480 | Нижняя граница рабочей области |
| SafeZone.left | -840 | Левая граница рабочей области |
| SafeZone.right | 840 | Правая граница рабочей области |

---

## Форматирование кода (внутри строк)

### Отступы
- **2 пробела** (не табы)
- Внутри `{ }` — всегда отступ

### Пустые строки
- После `{` класса
- Между полями и конструктором
- Между конструктором и методами
- Перед `return` (если есть подготовка)

### Переносы
- Fluent-цепочки — "лесенкой":
  ```java
  dsl.selectFrom(PAYMENTS)
    .where(condition)
    .fetch();
  ```

---

## Цветовая тема (ExplainorCodeTheme)

| Токен | Цвет | Примеры |
|-------|------|---------|
| keyword | #E6B47C (оранжевый) | `final`, `class`, `return`, `this` |
| type | #D5CCBF (бежевый) | `List`, `String`, + customTypes |
| constant | #C8B8D8 (лавандовый) | `PAYMENTS`, `ORDERS` |
| method | #B8D4E8 (голубой) | `.selectFrom()`, `.fetch()` |
| string | #B2C7C9 (голубой) | `"text"` |
| number | #A5C9CA (голубой) | `123`, `0.5` |
| plain | #FCFBF8 (белый) | переменные, параметры |
| punctuation | #EBE8E2 (бежево-белый) | `{}`, `()`, `;` |
| comment | #4A505E (тёмный) | `// comment` |

---

## Карточка (card vs nocard)

- **card** (по умолчанию) — фон + тень
- **nocard** — прозрачный фон, только код:
  ```typescript
  import {NoCardStyle} from '../core/ScreenGrid';
  
  CodeBlock.fromCode(CODE, {
    ...layout,
    cardStyle: NoCardStyle,
  });
  ```

---

## Таблицы (layout + measureText)

### Ключевая идея

Таблицу **нельзя** собирать через ручные `x/y` для каждой ячейки. Нужны две опоры:
1) **Layout Motion Canvas** (`layout`, `direction`, `padding`, `alignItems`) — отвечает за геометрию
2) **Реальное измерение текста** (`CanvasRenderingContext2D.measureText()`) — отвечает за ellipsis

### Гарантии

- Текст не вылезает за границы: сначала `fitText(...)` (ellipsis по реальному `measureText`), затем `clip` как страховка.
- Колонки стабильные: ширины колонок фиксированы (px), без процентов.
- Таблица fit-content: ширина карточки = `sum(col.width) + padding*2`.

### API для ellipsis

Файл: `motion-canvas/src/core/utils/textMeasure.ts`

- `fitText(text, maxPx, mode, fontFamily, fontSize, fontWeight)`
  - mode: `'end'` (обычный ellipsis) или `'middle'` (UUID как в DB-гридах)

### Референс-паттерн (таблица рядом с кодом)

```typescript
import {Rect, Txt, makeScene2D} from '@motion-canvas/2d';
import {createRef} from '@motion-canvas/core';
import {fitText} from '../core/utils/textMeasure';
import {SafeZone} from '../core/ScreenGrid';

const TABLE_PADDING = 24;
const ROW_H = 52;
const CELL_PX = 16;

const columns = [
  {key: 'id', header: 'id', width: 280, ellipsis: 'middle', align: 'left'},
  {key: 'status', header: 'status', width: 150, ellipsis: 'end', align: 'left'},
  {key: 'cents', header: 'cents', width: 110, ellipsis: 'end', align: 'right'},
  {key: 'created_at', header: 'created_at', width: 180, ellipsis: 'end', align: 'right'},
];

const tableWidth = columns.reduce((s, c) => s + c.width, 0) + TABLE_PADDING * 2;

// tableX/tableY: справа от кода с фиксированным gap, но не выходя за SafeZone
```

### Цвета статусов (рекомендация)

- success: `#A8D8C0`
- warning: `#E6B47C`
- muted: `Colors.text.muted`

---

## Ключевые файлы

| Файл | Назначение |
|------|------------|
| `motion-canvas/src/scenes/*.tsx` | Сцены видео |
| `motion-canvas/src/core/ScreenGrid.ts` | placeCode, placeCodeStack, SafeZone |
| `motion-canvas/src/core/code/model/SyntaxTheme.ts` | Цветовая тема |
| `motion-canvas/src/core/code/model/Tokenizer.ts` | Токенизатор (customTypes) |
| `motion-canvas/src/core/code/components/CodeBlock.ts` | Компонент кода |
| `motion-canvas/src/core/code/shared/TextMeasure.ts` | Расчёт размеров |
| `motion-canvas/src/core/utils/textMeasure.ts` | Реальное измерение текста + ellipsis |

---

## ВАЖНО: core не трогать!

Файлы в `motion-canvas/src/core/` менять только по явной просьбе.
