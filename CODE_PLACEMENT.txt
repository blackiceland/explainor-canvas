# CODE_PLACEMENT — Техническое API размещения кода и таблиц

## Назначение

Контракты API, геометрия, константы. Без режиссуры (см. SCENE_PATTERNS.txt).

---

## Safe Zone

| Граница | Значение |
|---------|----------|
| top | -480 |
| bottom | 480 |
| left | -840 |
| right | 840 |

Размер: 1680×960px

---

## API: placeCode / placeCodeStack

### placeCode — одиночный блок
```typescript
const layout = placeCode(CODE, 'TL', 16);
// → { x, y, width, fontSize }
```

### placeCodeStack — вертикальный стек
```typescript
const layouts = placeCodeStack([CODE1, CODE2], 'L', 16);
// → [{ x, y, width, height, fontSize }, ...]
```

**align**: `'L'` (слева), `'C'` (центр), `'R'` (справа)

### Позиции
```
    TL   TC   TR
    ML   C    MR
    BL   BC   BR
```
Алиасы: `L` = ML, `R` = MR, `T` = TC, `B` = BC

---

## API: CodeBlock

### Создание
```typescript
const block = CodeBlock.fromCode(CODE, {
  x, y, width, height,
  fontSize: 16,
  lineHeight: 27.2,  // fontSize * 1.7
  fontFamily: Fonts.code,
  theme: ExplainorCodeTheme,
  contentOffsetY: 28,  // сдвиг контента от верха (для карточек с запасом)
  customTypes: ['MyClass', 'Filter'],  // подсветка кастомных типов
});
block.mount(view);
```

### Появление/исчезновение
- `appear(duration)` — fade in
- `disappear(duration)` — fade out
- `moveTo(x, y, duration)` — переместить

### Подсветка строк
- `highlightLines([[from, to], ...], duration)` — приглушить остальное
- `dimLines(from, to, opacity, duration)` — приглушить диапазон
- `showAllLines(duration)` — вернуть opacity всех строк

### Цвет строк/токенов
- `recolorLine(lineIndex, color, duration)` — перекрасить всю строку
- `recolorTokens(lineIndex, ['pattern'], color, duration)` — перекрасить токены по паттерну
- `resetLineColors(lineIndex, duration)` — вернуть оригинальные цвета

### Позиционирование строк (для animateInsertLines)
- `getLineLayouts()` — получить `[{index, y}, ...]`
- `setLinePosition(index, y)` — установить Y мгновенно
- `setLineOpacity(index, opacity)` — установить opacity мгновенно
- `animateLinePosition(index, y, duration)` — анимировать Y
- `animateLineOpacity(index, opacity, duration)` — анимировать opacity
- `animateInsertLines([start, end], currentY[], duration)` — вставить блок, сдвинуть остальные

### Управление токенами
- `setTokenOpacityAt(lineIndex, tokenIndex, opacity)` — скрыть/показать токен (tokenIndex: -1 = последний)
- `animateTokenOpacityAt(lineIndex, tokenIndex, opacity, duration)` — анимированно

### Скролл
- `animateScrollY(deltaY, duration)` — сдвинуть контент вверх

---

## Padding (отступ код ↔ край карточки)

- **X**: `fontSize * 2 + 8`, ограничено 24–56px (при fontSize 16 → 40px)
- **Y**: `fontSize * 1.5 + 8`, ограничено 24–48px (при fontSize 16 → 32px)

---

## Константы

| Константа | Значение |
|-----------|----------|
| STACK_GAP | 60px |
| MIN_CARD_WIDTH | 300px |
| MAX_CARD_WIDTH | 1600px |
| Line height ratio | 1.7 |

---

## customTypes (ВАЖНО)

AI должен анализировать код и добавлять кастомные типы:
1. Найти слова с заглавной буквы (классы/типы)
2. Исключить стандартные (List, Map, String, Optional)
3. Добавить в `customTypes`

Без этого кастомные классы будут белыми вместо бежевых.

---

## Цветовая тема (ExplainorCodeTheme)

| Токен | Цвет | Примеры |
|-------|------|---------|
| keyword | #E2B7C1 | `final`, `class`, `return` |
| type | #D5CCBF | `List`, `String`, customTypes |
| constant | #C8B8D8 | `PAYMENTS`, `ORDERS` |
| method | #B8D4E8 | `.selectFrom()`, `.fetch()` |
| string | #B2C7C9 | `"text"` |
| number | #A5C9CA | `123` |
| plain | #FCFBF8 | переменные, параметры |
| punctuation | #EBE8E2 | `{}`, `()`, `;` |
| operator | #CFC7BC | `!=`, `&&` |

**Правило**: оранжевый НЕ используется в подсветке кода.

---

## Overflow: что делать если код не влезает

**НЕ делаем**:
- Уменьшать fontSize автоматически
- Менять синтаксис / делать псевдокод
- Сокращать имена переменных

**Делаем**:
- Переносим длинные строки в Java-стиле (лесенкой)
- Переносим ТОЛЬКО то, что реально не помещается

```java
conditions = conditions.and(
  ORDERS.CREATED_AT.ge(filter.createdSince())
);
```

`clip` у карточки — safety-belt, а не решение.

---

## Операторы: без лигатур

Код должен выглядеть как реальный Java: `!=` а не `≠`, `>=` а не `≥`.

Контракт: лигатурные операторы рендерятся посимвольно.

---

## Форматирование кода

- **Отступы**: 2 пробела
- **Пустые строки**: после `{` класса, между методами, перед `return`
- **Переносы**: только при переполнении или явном улучшении читаемости

---

## Таблицы (краткое API)

### Геометрия (код + таблица рядом)
```typescript
const gap = 120;
const totalWidth = SafeZone.right - SafeZone.left;
const cardWidth = (totalWidth - gap) / 2;
const codeX = SafeZone.left + cardWidth / 2;
const tableX = SafeZone.right - cardWidth / 2;
```

### Ключевые правила
- Колонки: `grow={1} shrink={1} basis={0} minWidth={0}`
- Разделители: отдельные вертикальные `Rect` (не stroke)
- Overflow: `fitText()` + `clip` как страховка
- Цвета статусов: success `#A8D8C0`, warning `#E6B47C`, muted `Colors.text.muted`

### Референс
Полный пример таблицы: `dryFiltersScene.tsx`

---

## Авто-ширина карточки

Для одиночной центральной карточки:
```typescript
function codeCardWidth(code, fontFamily, fontSize, paddingX) {
  const maxLinePx = Math.max(0, ...code.split('\n').map(
    line => textWidth(line, fontFamily, fontSize, 400)
  ));
  return Math.min(1600, Math.max(900, Math.ceil(maxLinePx + paddingX * 2)));
}
```

Референс: `dryConditionsScene.tsx`

---

## Скорости анимаций

| Действие | Timing |
|----------|--------|
| Появление/исчезновение карточек | `Timing.slow` |
| Подсветка строк/токенов | `Timing.slow` |
| Возврат из подсветки | `~0.8s` (restoreDur) |
| Мерцание | `0.16s` |

**Правило**: в финале сцены код возвращается в нормальный вид.

---

## Ключевые файлы

| Файл | Назначение |
|------|------------|
| `core/ScreenGrid.ts` | placeCode, placeCodeStack, SafeZone |
| `core/code/components/CodeBlock.ts` | Компонент кода |
| `core/code/components/CodeLine.ts` | Строка кода |
| `core/code/model/SyntaxTheme.ts` | Цветовая тема |
| `core/code/model/Tokenizer.ts` | Токенизатор |
| `core/utils/textMeasure.ts` | measureText, fitText, textWidth |

---

## ВАЖНО

- `CODE_PLACEMENT.txt` изменяется только по явной просьбе
- Файлы в `core/` менять только по явной просьбе
- Сценарные паттерны → см. `SCENE_PATTERNS.txt`
- Визуальный стиль → см. `DESIGN_STYLE.txt`
